<div class="messages-container">
    <div class="messages" id = "custom-message">
        <p class="messages-title">{{#str}}messages, theme_stardust{{/str}}</p>
        <div class="messages-list-wrapper">
          <div class="messages-list">
            <!-- output  for teacher-->
            {{#output.get_all_messages.messages}}
              {{#.}}
                <form class="message">
                  <input type="text" name="message" value="Type your message here." maxlength="100" placeholder="" class="message-input" readonly>
                  <div class="message-controls">
                    <input type="button" name="" value="&rarr;" class="message-submit" title="submit">
                    <!-- <input type="submit" name="" value="&rarr;" class="message-submit" title="submit"> -->
                    <input type="button" name="" value="&times;" class="message-clear" title="clear message">
                    <div class="submit-icons"></div>
                  </div>
                </form>
              {{/.}}
            {{/output.get_all_messages.messages}}
            <!-- output for students -->
            {{^output.get_all_messages.messages}}
              {{#.}}
                <!-- <div class="message">{{#str}}no_messages, theme_stardust{{/str}}</div> -->
                <!-- NOTE: next form is used for debugging only -->
                <form class="message">
                  <input type="text" name="message" value="Type your message here." maxlength="100" placeholder="" class="message-input" readonly>
                  <div class="message-controls">
                    <input type="button" name="" value="&rarr;" class="message-submit" title="submit">
                    <!-- <input type="submit" name="" value="&rarr;" class="message-submit" title="submit"> -->
                    <input type="button" name="" value="&times;" class="message-clear" title="clear message">
                    <div class="submit-icons"></div>
                  </div>
                </form>
              {{/.}}
            {{/output.get_all_messages.messages}}
            {{#output.get_all_messages.warnings}}
              {{#.}}
                <div class="message"><a href="{{config.wwwroot}}/message/output/popup/notifications.php?notificationid={{id}}">{{subject}}</a></div>
              {{/.}}
            {{/output.get_all_messages.warnings}}
          </ul>
        </div>
    </div>
</div>



{{#js}}
require(['jquery', 'theme_stardust/ajax'], function($, ajax){

  const message = document.querySelector('#course-main-content .message-input');
  const submit = document.querySelector('#course-main-content .message-submit');
  const clear = document.querySelector('#course-main-content .message-clear');

  // on send spinner
  // const spinner = document.createElement('span');
  // spinner.classList += 'message-spin';
  const spinner = '<span class="message-spin"></span>';

  // on send success
  const check = '<svg class="message-sent" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 130.2 130.2"><polyline class="path check" fill="none" stroke="#83D3AE" stroke-width="15" stroke-linecap="round" stroke-miterlimit="10" points="100.2,40.2 51.5,88.8 29.8,67.5 "/></svg>';

  // hide controls
  $(submit).css({'display':'none'});
  $(clear).css({'display':'none'});

  const getUserId = function (){
    // TODO: add data-userid to form.message
    var source = document.querySelector('.popover-region');
    var userid = source.dataset.userid;

    return userid;
  };
  //console.log(getUserId());

  const getCourseId = function (){
    var queries = window.location.search.replace(/^\?/, '').split('&');
    // console.log(queries);
    for( i = 0; i < queries.length; i++ ) {
      var q = queries[i].trim();
      // console.log(q.indexOf('id'));
      if (q.indexOf('id') == 0){
        var courseid = q.substring(3, q.length);
      }
    }
    return courseid;
  };
  // console.log(window.location.search);
  // console.log(getCourseId());

  const  getSessionKey = function (){
    var cookies = document.cookie.split(';');
    for(var i = 0; i < cookies.length; i++) {
      var c = cookies[i].trim();
      var name = 'MoodleSession';
      if (c.indexOf(name) == 0) {
        var session = c.substring(name.length+1, c.length);
      }
    }
    return session;
  };
  // console.log(document.cookies);
  // console.log(getSessionKey());

  const targetBlock = document.querySelector('.submit-icons');

  const animation = function() {
    $(submit).css({'display':'none'});
    $(clear).css({'display':'none'});
    //targetBlock.appendChild(spinner);
    targetBlock.innerHTML = spinner;
    setTimeout(function(){
      targetBlock.innerHTML = check;
    },1500);
  };

  message.addEventListener('focus', function(e){
    e.preventDefault();
    message.removeAttribute('readonly');
  }, true);
  // message.addEventListener('input', function(){
  // }, true);
  clear.addEventListener('click', function(){
    message.value = "";
  });
  message.addEventListener('keyup', function(e) {
    e.preventDefault();
    // Enter
    if (event.keyCode === 13) {
      submit.click();
    } else if (event.keyCode === 8) {
      $(clear).css({'display':'inline-block'});
      $(submit).css({'display':'none'});
    } else {
      $(submit).css({'display':'inline-block'});
      $(clear).css({'display':'none'});
    }
  });
  submit.addEventListener('click', function(){

    ajax.data = {
      method: "POST",
      url: "{{config.wwwroot}}/theme/stardust/classes/classAjax.php",
      user: getUserId(),
      courseid: getCourseId(),
      sesskey: getSessionKey(),
      message: message.value
    };
    animation();
    console.log("user: "+ getUserId());
    console.log("courseid: "+getCourseId());
    console.log("sesskey: "+getSessionKey());
    console.log("url: "+ajax.data.url);
    console.log("message: "+ajax.data.message);
    ajax.send();



  });

});
{{/js}}
