<div class="messages-container">
    <div class="messages" id = "custom-message">
        <p class="messages-title">{{#str}}messages, theme_stardust{{/str}}</p>
        <div class="messages-list-wrapper">
          <div class="messages-list">
            {{#isteacher}}
                  <form class="message" data-userid={{userid}} {{coursemessage.teachmessageshowhide}}>
                    <input type="text" name="message" value="{{coursemessage.message}}" maxlength="100" placeholder="" class="message-input" readonly>
                    <div class="message-controls">
                      <input type="button" name="" value="&rarr;" class="message-submit" title="submit">
                      <input type="button" name="" value="&times;" class="message-clear" title="clear message">
                      <div class="submit-icons"></div>
                    </div>
                  </form>
            {{/isteacher}}
            {{^isteacher}}
                <div class="message" {{coursemessage.studmessageshowhide}}>{{coursemessage.message}}</div>
            {{/isteacher}}
          </div>
        </div>
    </div>
</div>
{{#isteacher}}
<button type="button" name="message-hider" class="message-hider {{coursemessage.buttonstatus}}" title="{{coursemessage.buttontitle}}"></button>
{{/isteacher}}


{{#js}}
require(['core/yui', 'jquery', 'theme_stardust/ajax'], function(Y, $, ajax){

  const message = document.querySelector('#course-main-content .message-input');
  const submit = document.querySelector('#course-main-content .message-submit');
  const clear = document.querySelector('#course-main-content .message-clear');
  const hider = document.querySelector('#course-main-content .message-hider');

  // on send spinner
  const spinner = '<span class="message-spin"></span>';

  // on send success
  const check = '<svg class="message-sent" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 130.2 130.2"><polyline class="path check" fill="none" stroke="#83D3AE" stroke-width="15" stroke-linecap="round" stroke-miterlimit="10" points="100.2,40.2 51.5,88.8 29.8,67.5 "/></svg>';

  // hide controls
  $(submit).css({'display':'none'});
  $(clear).css({'display':'none'});

  const getCourseId = function (){
    var queries = window.location.search.replace(/^\?/, '').split('&');
    for( i = 0; i < queries.length; i++ ) {
      var q = queries[i].trim();
      if (q.indexOf('id') == 0){
        var courseid = q.substring(3, q.length);
      }
    }
    return courseid;
  };

  const targetBlock = document.querySelector('.submit-icons');

  const animation = function() {
    $(submit).css({'display':'none'});
    $(clear).css({'display':'none'});
    //targetBlock.appendChild(spinner);
    targetBlock.innerHTML = spinner;
    setTimeout(function(){
      targetBlock.innerHTML = check;
    },1500);
  };

  $('form.message').submit(function(e){
    return false;
  });

  hider.addEventListener('click', function(){
    if(hider.classList.contains('show')){
      var hiderstatus = 0;
      $(hider).removeClass('show');
    } else {
      var hiderstatus = 1;
      $(hider).addClass('show');
    }
    ajax.data = {
      method: "toggle_course_message_status",
      url: "{{config.wwwroot}}/theme/stardust/classes/classAjax.php",
      user: document.querySelector('form.message').dataset.userid,
      courseid: getCourseId(),
      sesskey: M.cfg.sesskey,
      status: hiderstatus
    };
    ajax.send();
  });

  message.addEventListener('focus', function(e){
    e.preventDefault();
    message.removeAttribute('readonly');
  }, true);
  message.addEventListener('blur', function(e) {
    submit.click();
  }, true);
  clear.addEventListener('click', function(){
    message.value = "";
  });
  message.addEventListener('keyup', function(e) {
    e.preventDefault();
    // Enter
    if (event.keyCode === 13) {
      submit.click();
    } else if (event.keyCode === 8) {
      $(clear).css({'display':'inline-block'});
      $(submit).css({'display':'none'});
    } else {
      $(submit).css({'display':'inline-block'});
      $(clear).css({'display':'none'});
    }
  });
  submit.addEventListener('click', function(){

    ajax.data = {
      method: "send_course_message",
      url: "{{config.wwwroot}}/theme/stardust/classes/classAjax.php",
      user: document.querySelector('form.message').dataset.userid,
      courseid: getCourseId(),
      sesskey: M.cfg.sesskey,
      message: message.value
    };
    animation();
    ajax.send();



  });

});
{{/js}}
